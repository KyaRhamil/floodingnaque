# =====================================================
# Floodingnaque - Staging Docker Compose
# =====================================================
# Usage:
#   docker-compose -f docker-compose-staging.yml up -d --build
#   docker-compose -f docker-compose-staging.yml logs -f backend
#   docker-compose -f docker-compose-staging.yml down
# =====================================================
# NOTE: This configuration uses Supabase as the database.
#       Ensure DATABASE_URL is set in ./backend/.env.staging pointing to Supabase.
# =====================================================

services:
  # ===================
  # Backend API Service
  # ===================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: floodingnaque-api-staging
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - APP_ENV=staging
      - FLASK_DEBUG=False
      - PORT=5000
      - HOST=0.0.0.0
      - PYTHONPATH=/app
      # DATABASE_URL is loaded from .env.staging file (points to Supabase)
      # Redis for rate limiting (optional in staging)
      - RATE_LIMIT_STORAGE_URL=redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      - RATE_LIMIT_ENABLED=True
      # Security
      - AUTH_BYPASS_ENABLED=False
      # CORS - Set your staging frontend domain
      - CORS_ORIGINS=${CORS_ORIGINS:-https://staging.floodingnaque.vercel.app}
      # Logging
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      # Weather API Keys (from .env.staging)
      - OWM_API_KEY=${OWM_API_KEY}
      - WEATHERSTACK_API_KEY=${WEATHERSTACK_API_KEY:-}
      # Scheduler
      - SCHEDULER_ENABLED=True
      - SCHEDULER_TIMEZONE=Asia/Manila
    env_file:
      - ./backend/.env.staging
    volumes:
      # Persistent data volumes (no code mounting in staging!)
      - floodingnaque_models_staging:/app/models
      - floodingnaque_logs_staging:/app/logs
      - floodingnaque_data_staging:/app/data
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - floodingnaque-staging
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===================
  # Redis (Rate Limiting & Cache)
  # ===================
  redis:
    image: redis:7.2-alpine
    container_name: floodingnaque-redis-staging
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:-changeme}
    ports:
      - "6379:6379"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    volumes:
      - redis_data_staging:/data
    networks:
      - floodingnaque-staging
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

# ===================
# Networks
# ===================
networks:
  floodingnaque-staging:
    driver: bridge
    name: floodingnaque-staging

# ===================
# Volumes
# ===================
volumes:
  redis_data_staging:
    name: floodingnaque-redis-staging
  floodingnaque_models_staging:
    name: floodingnaque-models-staging
  floodingnaque_logs_staging:
    name: floodingnaque-logs-staging
  floodingnaque_data_staging:
    name: floodingnaque-data-staging
