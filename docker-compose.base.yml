# =====================================================
# Floodingnaque - Base Docker Compose Configuration
# =====================================================
# This file contains shared service definitions.
# Use with environment-specific override files:
#
#   Development (auto-loads docker-compose.override.yml):
#     docker-compose up -d
#
#   Development with Supabase:
#     docker-compose -f docker-compose.base.yml -f docker-compose-development.yml up -d
#
#   Staging:
#     docker-compose -f docker-compose.base.yml -f docker-compose-staging.yml up -d
#
#   Production:
#     docker-compose -f docker-compose.base.yml -f docker-compose-production.yml up -d
#
# =====================================================

x-backend-base: &backend-base
  build:
    context: ./backend
    dockerfile: Dockerfile
  restart: unless-stopped
  environment: &backend-env-base
    - PORT=5000
    - HOST=0.0.0.0
    - PYTHONPATH=/app
  healthcheck: &backend-healthcheck
    test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s

x-redis-base: &redis-base
  image: redis:7.2-alpine
  restart: unless-stopped
  healthcheck: &redis-healthcheck
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 5

x-postgres-base: &postgres-base
  image: postgres:15.5-alpine
  restart: unless-stopped
  healthcheck: &postgres-healthcheck
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 10s

x-logging-default: &logging-default
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-logging-production: &logging-production
  driver: "json-file"
  options:
    max-size: "50m"
    max-file: "5"
    compress: "true"

x-labels-common: &labels-common
  com.floodingnaque.project: "floodingnaque"
  com.floodingnaque.maintainer: "Floodingnaque Team"

# Resource limits
x-resources-small: &resources-small
  limits:
    cpus: '0.5'
    memory: 512M
  reservations:
    cpus: '0.1'
    memory: 128M

x-resources-medium: &resources-medium
  limits:
    cpus: '1'
    memory: 1G
  reservations:
    cpus: '0.25'
    memory: 256M

x-resources-large: &resources-large
  limits:
    cpus: '2'
    memory: 2G
  reservations:
    cpus: '0.5'
    memory: 512M

x-security-opts: &security-opts
  security_opt:
    - no-new-privileges:true
