# =====================================================
# FLOODINGNAQUE - PgBouncer Connection Pooler Configuration
# =====================================================
# PgBouncer provides connection pooling for PostgreSQL
# reducing connection overhead and improving performance.
#
# Documentation: https://www.pgbouncer.org/config.html
# =====================================================

[databases]
# Primary database connection (write operations)
# Template uses environment variables substituted by entrypoint.sh
floodingnaque = host=${DB_HOST} port=${DB_PORT} dbname=${DB_NAME} auth_user=${DB_USER}

# Read replica for dashboard queries (if available)
# Fallback to primary if replica not configured
floodingnaque_readonly = host=${DB_REPLICA_HOST:-${DB_HOST}} port=${DB_REPLICA_PORT:-${DB_PORT}} dbname=${DB_NAME} auth_user=${DB_USER}

[pgbouncer]
# =====================================================
# Connection Pooling Settings
# =====================================================

# Listen address and port
listen_addr = 0.0.0.0
listen_port = 6432

# Unix socket directory (optional)
; unix_socket_dir = /var/run/pgbouncer

# =====================================================
# Authentication
# =====================================================

# Authentication type: md5, scram-sha-256, plain, trust, any
# Using md5 for compatibility with our hashed password generation
auth_type = md5

# Password file location
auth_file = /etc/pgbouncer/userlist.txt

# Query to fetch user passwords from database (for auth_query mode)
; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

# =====================================================
# Pool Settings
# =====================================================

# Pool mode: session, transaction, statement
# - session: Default, connection assigned for client session lifetime
# - transaction: Connection returned to pool after each transaction (RECOMMENDED)
# - statement: Connection returned after each statement (most aggressive)
pool_mode = transaction

# Maximum number of client connections allowed
max_client_conn = 1000

# Default pool size per user/database pair
default_pool_size = 25

# Minimum pool size (kept ready even without clients)
min_pool_size = 5

# How many additional connections to allow above pool_size
reserve_pool_size = 10

# Time (seconds) before reserve_pool connections are used
reserve_pool_timeout = 5

# Maximum number of server connections for all pools
max_db_connections = 50

# Maximum number of connections per user
max_user_connections = 40

# =====================================================
# Connection Lifecycle
# =====================================================

# Time (seconds) to wait for a connection before timing out
server_connect_timeout = 5

# Time (seconds) a server connection can be idle before closing
server_idle_timeout = 600

# Time (seconds) a server connection can live before recycling
server_lifetime = 3600

# Time (seconds) client can wait for a server connection
client_idle_timeout = 300

# Close client connections after this many seconds of inactivity
client_login_timeout = 60

# =====================================================
# Query Settings
# =====================================================

# Time (seconds) before canceling a query
query_timeout = 300

# Wait for this long (seconds) for response before killing server connection
query_wait_timeout = 120

# Enable prepared statements (disable for transaction pooling)
max_prepared_statements = 0

# Statement to run when connection is created
server_reset_query = DISCARD ALL

# Statement to run when connection is released
server_check_query = SELECT 1

# Delay between connection checks
server_check_delay = 30

# =====================================================
# TLS/SSL Configuration
# =====================================================

# Client TLS settings
client_tls_sslmode = prefer
; client_tls_key_file = /etc/pgbouncer/server.key
; client_tls_cert_file = /etc/pgbouncer/server.crt
; client_tls_ca_file = /etc/pgbouncer/ca.crt

# Server TLS settings (to PostgreSQL)
server_tls_sslmode = ${DB_SSL_MODE:-require}
; server_tls_ca_file = /etc/pgbouncer/prod-ca-2021.crt

# =====================================================
# Logging
# =====================================================

# Log file location (empty for stdout in Docker)
; logfile = /var/log/pgbouncer/pgbouncer.log

# PID file location
; pidfile = /var/run/pgbouncer/pgbouncer.pid

# Log level: debug, info, notice, warning, error, fatal
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

# Log statistics in verbose format
verbose = 0

# =====================================================
# Admin Access
# =====================================================

# Admin console database
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

# Ignore connection startup parameters
ignore_startup_parameters = extra_float_digits

# =====================================================
# Process Settings (for Docker)
# =====================================================

# Don't daemonize in Docker
; so_reuseport = 1

# TCP keepalive settings
tcp_keepalive = 1
tcp_keepcnt = 5
tcp_keepidle = 30
tcp_keepintvl = 10

# Socket buffer sizes
pkt_buf = 4096
sbuf_loopcnt = 5

# Application name tracking
application_name_add_host = 1
