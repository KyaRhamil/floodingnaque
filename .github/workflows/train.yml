name: ML Training Pipeline

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Model version to train (e.g., 6 for v6)'
        required: false
        default: '6'
      grid_search:
        description: 'Enable grid search (slower but better results)'
        required: false
        default: false
        type: boolean
      promote_to_staging:
        description: 'Automatically promote to staging if criteria met'
        required: false
        default: true
        type: boolean

  # Weekly retraining schedule
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC

  # Trigger on data changes
  push:
    paths:
      - 'backend/data/processed/**'
      - 'backend/scripts/train_enterprise.py'
    branches:
      - main

# Restrict permissions to minimum required for security (principle of least privilege)
permissions:
  contents: read
  actions: read

env:
  PYTHON_VERSION: '3.11'
  MLFLOW_TRACKING_URI: 'mlruns'

jobs:
  validate-data:
    name: Validate Training Data
    runs-on: ubuntu-latest
    outputs:
      data_valid: ${{ steps.validate.outputs.valid }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pandera

      - name: Validate data
        id: validate
        run: |
          cd backend
          python -c "
          import sys
          sys.path.insert(0, '.')
          from scripts.enterprise.data_validation import FloodDataValidator
          import pandas as pd

          validator = FloodDataValidator()
          df = pd.read_csv('data/processed/cumulative_up_to_2025.csv')
          _, errors = validator.validate(df, raise_on_error=False)

          if errors:
              print('::warning::Data validation found issues:')
              for e in errors[:5]:
                  print(f'  - {e}')
              if len(errors) > 5:
                  print(f'  ... and {len(errors) - 5} more')

          # Only fail on critical errors
          critical = [e for e in errors if e.get('type') in ['missing_columns', 'insufficient_samples']]
          if critical:
              print('::error::Critical data validation errors found')
              sys.exit(1)

          print('valid=true', file=open('$GITHUB_OUTPUT', 'a'))
          "

  train:
    name: Train Model
    needs: validate-data
    if: needs.validate-data.outputs.data_valid == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install mlflow pandera pyyaml structlog

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Train model
        id: train
        run: |
          cd backend

          VERSION="${{ github.event.inputs.version || '6' }}"
          GRID_SEARCH="${{ github.event.inputs.grid_search || 'false' }}"

          echo "Training model version: $VERSION"
          echo "Grid search enabled: $GRID_SEARCH"

          if [ "$GRID_SEARCH" == "true" ]; then
            python scripts/train_enterprise.py --version $VERSION --grid-search
          else
            python scripts/train_enterprise.py --version $VERSION
          fi

          # Extract metrics for summary
          if [ -f "reports/enterprise_training_report.json" ]; then
            echo "## Training Results" >> $GITHUB_STEP_SUMMARY
            python -c "
          import json
          with open('reports/enterprise_training_report.json') as f:
              report = json.load(f)

          metrics = report.get('metrics', {})
          print(f'| Metric | Value |')
          print(f'|--------|-------|')
          print(f'| Accuracy | {metrics.get(\"accuracy\", 0):.4f} |')
          print(f'| F1 Score | {metrics.get(\"f1_score\", 0):.4f} |')
          print(f'| ROC-AUC | {metrics.get(\"roc_auc\", 0):.4f} |')
          print(f'| CV Mean | {metrics.get(\"cv_mean\", 0):.4f} |')
            " >> $GITHUB_STEP_SUMMARY
          fi
        env:
          FLOODINGNAQUE_ENABLE_MLFLOW: 'true'

      - name: Upload model artifacts
        uses: actions/upload-artifact@v6
        with:
          name: trained-model-v${{ github.event.inputs.version || '6' }}
          path: |
            backend/models/*.joblib
            backend/models/*.json
            backend/reports/enterprise_training_report.json
          retention-days: 30

      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: mlflow-runs
          path: backend/mlruns/
          retention-days: 14

  validate-model:
    name: Validate Trained Model
    needs: train
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r backend/requirements.txt

      - name: Download model artifacts
        uses: actions/download-artifact@v7
        with:
          name: trained-model-v${{ github.event.inputs.version || '6' }}
          path: backend/

      - name: Validate model
        id: validate
        run: |
          cd backend
          python scripts/validate_model.py

          if [ $? -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

  promote-staging:
    name: Promote to Staging
    needs: [train, validate-model]
    if: |
      needs.validate-model.outputs.validation_passed == 'true' &&
      (github.event.inputs.promote_to_staging == 'true' || github.event_name == 'schedule')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pyyaml

      - name: Download model artifacts
        uses: actions/download-artifact@v7
        with:
          name: trained-model-v${{ github.event.inputs.version || '6' }}
          path: backend/

      - name: Promote to staging
        run: |
          cd backend
          VERSION="${{ github.event.inputs.version || '6' }}"

          python -c "
          import sys
          sys.path.insert(0, '.')
          from scripts.enterprise.model_registry import create_registry, ModelStage
          from pathlib import Path

          registry = create_registry(Path('models'))

          # Check if version exists in registry
          if $VERSION in registry.versions:
              success, message = registry.promote($VERSION, ModelStage.STAGING)
              print(message)
              if not success:
                  sys.exit(1)
          else:
              print(f'Version $VERSION not found in registry')
              sys.exit(1)
          "

      - name: Create staging deployment summary
        run: |
          echo "## Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Model v${{ github.event.inputs.version || '6' }} promoted to staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To promote to production, run the promote-production workflow." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Results
    needs: [train, validate-model, promote-staging]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Send notification
        run: |
          echo "## Training Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Train | ${{ needs.train.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate-model.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Promote | ${{ needs.promote-staging.result }} |" >> $GITHUB_STEP_SUMMARY
