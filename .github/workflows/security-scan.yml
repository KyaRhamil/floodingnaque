name: Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**/*.py'
      - 'backend/requirements*.txt'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**/*.py'
      - 'backend/requirements*.txt'
  schedule:
    # Run weekly security scans on Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Scan type to run (all, pip-audit, bandit, safety)'
        required: false
        default: 'all'
      fail_on:
        description: 'Fail on severity level (critical, high, medium, low)'
        required: false
        default: 'critical'

permissions:
  contents: read
  security-events: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # GitGuardian Secret Scanning
  # ===========================================================================
  ggshield-scan:
    name: GitGuardian Secret Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for scanning commit history
      
      - name: Run ggshield secret scan
        uses: GitGuardian/ggshield-action@v1
        with:
          args: secret scan ci
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  # ===========================================================================
  # Comprehensive Security Scan using security_scan.py
  # ===========================================================================
  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit safety
          pip install -r backend/requirements.txt

      - name: Create reports directory
        run: mkdir -p backend/reports/security

      - name: Run security scan script
        id: security_scan
        run: |
          cd backend
          python scripts/security_scan.py \
            --scan-type ${{ github.event.inputs.scan_type || 'all' }} \
            --output-format json \
            --output-dir reports/security \
            --ci \
            --fail-on ${{ github.event.inputs.fail_on || 'critical' }} \
            2>&1 | tee security-scan-output.txt
        continue-on-error: true

      - name: Display scan summary
        if: always()
        run: |
          echo "=== Security Scan Summary ==="
          cat backend/security-scan-output.txt || true
          echo ""
          echo "=== Generated Reports ==="
          ls -la backend/reports/security/ || echo "No reports generated"

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results-${{ github.sha }}
          path: |
            backend/reports/security/
            backend/security-scan-output.txt
          retention-days: 90

      - name: Upload SARIF results (if available)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: backend/reports/security/
        continue-on-error: true

      - name: Check scan result
        if: steps.security_scan.outcome == 'failure'
        run: |
          echo "::error::Security scan found critical issues!"
          echo "Review the security-scan-results artifact for details."
          exit 1

  # ===========================================================================
  # Individual Security Tool Jobs (for parallel execution)
  # ===========================================================================
  pip-audit:
    name: pip-audit Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit on requirements.txt
        id: pip_audit_main
        run: |
          cd backend
          pip-audit -r requirements.txt \
            --strict \
            --desc on \
            --format json \
            --output pip-audit-results.json \
            2>&1 | tee pip-audit-output.txt || true

      - name: Run pip-audit on dev requirements
        id: pip_audit_dev
        run: |
          cd backend
          pip-audit -r requirements-dev.txt \
            --desc on \
            --format json \
            --output pip-audit-dev-results.json \
            2>&1 | tee pip-audit-dev-output.txt || true
        continue-on-error: true

      - name: Display pip-audit summary
        if: always()
        run: |
          echo "=== pip-audit Results (requirements.txt) ==="
          cat backend/pip-audit-output.txt || true
          echo ""
          echo "=== pip-audit Results (requirements-dev.txt) ==="
          cat backend/pip-audit-dev-output.txt || true

      - name: Upload pip-audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-results-${{ github.sha }}
          path: |
            backend/pip-audit-*.json
            backend/pip-audit-*.txt
          retention-days: 30

      - name: Check for critical vulnerabilities
        run: |
          cd backend
          # Parse JSON results and check for CRITICAL severity
          if [ -f pip-audit-results.json ]; then
            CRITICAL_COUNT=$(python -c "import json; d=json.load(open('pip-audit-results.json')); print(len([v for v in d.get('dependencies', []) if any(e.get('fix_versions') for e in v.get('vulns', []))]))" 2>/dev/null || echo "0")
            if [ "$CRITICAL_COUNT" -gt "0" ]; then
              echo "::warning::Found $CRITICAL_COUNT packages with known vulnerabilities"
            fi
          fi

  bandit:
    name: Bandit Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit on app code
        id: bandit_app
        run: |
          cd backend
          bandit -r app/ \
            -f json \
            -o bandit-app-results.json \
            --severity-level medium \
            --confidence-level medium \
            || true
          bandit -r app/ \
            -f txt \
            -o bandit-app-report.txt \
            --severity-level medium \
            --confidence-level medium \
            || true

      - name: Run Bandit on scripts
        id: bandit_scripts
        run: |
          cd backend
          bandit -r scripts/ \
            -f json \
            -o bandit-scripts-results.json \
            --severity-level medium \
            --confidence-level medium \
            || true

      - name: Display Bandit summary
        if: always()
        run: |
          echo "=== Bandit Results (app/) ==="
          cat backend/bandit-app-report.txt || echo "No issues found"

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-results-${{ github.sha }}
          path: |
            backend/bandit-*.json
            backend/bandit-*.txt
          retention-days: 30

      - name: Check for high severity issues
        run: |
          cd backend
          ISSUES=$(bandit -r app/ -f json --severity-level high 2>/dev/null | python -c "import json,sys; d=json.load(sys.stdin); print(len(d.get('results',[])))" 2>/dev/null || echo "0")
          if [ "$ISSUES" -gt "0" ]; then
            echo "::error::$ISSUES high-severity security issues found in app code!"
            bandit -r app/ -f txt --severity-level high
            exit 1
          fi
          echo "âœ“ No high-severity issues found"

  safety:
    name: Safety Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Safety
        run: pip install safety

      - name: Run Safety check
        run: |
          cd backend
          safety check -r requirements.txt \
            --json \
            --output safety-results.json \
            2>&1 | tee safety-output.txt || true

      - name: Display Safety summary
        if: always()
        run: |
          echo "=== Safety Check Results ==="
          cat backend/safety-output.txt || echo "No issues found"

      - name: Upload Safety results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-results-${{ github.sha }}
          path: |
            backend/safety-*.json
            backend/safety-*.txt
          retention-days: 30

  # ===========================================================================
  # Aggregate Security Report
  # ===========================================================================
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-scan, pip-audit, bandit, safety]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate aggregated report
        run: |
          echo "# Floodingnaque Security Scan Report" > SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> SECURITY_REPORT.md
          echo "**Commit:** ${{ github.sha }}" >> SECURITY_REPORT.md
          echo "**Branch:** ${{ github.ref_name }}" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## Scan Results Summary" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "| Scanner | Status |" >> SECURITY_REPORT.md
          echo "|---------|--------|" >> SECURITY_REPORT.md
          echo "| Comprehensive Scan | ${{ needs.security-scan.result }} |" >> SECURITY_REPORT.md
          echo "| pip-audit | ${{ needs.pip-audit.result }} |" >> SECURITY_REPORT.md
          echo "| Bandit | ${{ needs.bandit.result }} |" >> SECURITY_REPORT.md
          echo "| Safety | ${{ needs.safety.result }} |" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "## Artifacts" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "Detailed scan results are available in the workflow artifacts." >> SECURITY_REPORT.md

          cat SECURITY_REPORT.md

      - name: Upload aggregated report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.sha }}
          path: SECURITY_REPORT.md
          retention-days: 90

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('SECURITY_REPORT.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
